{{template "base" .}} {{ define "head" }}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
{{ end }} {{ define "main" }}
<div class="container">
  <div class="row">
    <div class="col-12 d-flex justify-content-center align-items-center">
      <h3 class="text-center">SopherTextAudio</h3>
      <p class="h5 text-center">
        Converts your text to an audio file you can listen to on the go.
      </p>
      <p class="h3 text-center">Copy. Paste. Download.</p>
    </div>
  </div>
  <div class="row">
    <div class="col-12 justify-content-center">
      <div id="editor">
        <p>Paste your text here and click Convert!</p>
      </div>
    </div>
    <div class="col-12 justify-content-end">
      <button class="btn btn-success" onclick="sendText()">Convert</button>
    </div>
  </div>
</div>
<!-- Include the Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  var quill = new Quill("#editor", {
    theme: "snow",
  });
  /**
   * Gets the token from local storage or redirects to the login screen
   * */
  function getTokenOrRedirectToLogin() {
    let tokenString = window.localStorage.getItem("token");
    if (!tokenString) {
      window.location.assign("/login");
    }
    return tokenString;
  }

  /**
   * Sends the text to the remote server and download the file
   * */
  function sendText() {
    let tokenString = getTokenOrRedirectToLogin();
    if (!tokenString) {
      return;
    }

    const body = JSON.stringify({
      text: quill.getText(),
    });

    fetch({
      url: "/",
      method: "POST",
      body,
      headers: {
        Authorization: `Bearer ${tokenString}`,
      },
    })
      .then((resp) => resp.blob)
      .then((blob) => {
        const fileUrl = window.URL.createObjectURL(blob);
        window.location.assign(fileUrl);
      })
      .catch((err) => {
        alert(err);
      });
  }

  // check this first so that user does not waste time
  getTokenOrRedirectToLogin();
</script>
{{ end }}
